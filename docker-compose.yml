version: '3.8'

services:
    # 1. База даних PostgreSQL
    db:
        image: postgres:16-alpine
        container_name: corpmind-postgres
        restart: always
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./init.sql:/docker-entrypoint-initdb.d/init.sql
        ports:
            - '5432:5432'
        networks:
            - app-network

    # 2. Векторна БД ChromaDB
    chroma:
        image: chromadb/chroma:latest
        container_name: corpmind-chroma
        restart: always
        volumes:
            - chroma_data:/chroma/chroma
        ports:
            - '8000:8000'
        networks:
            - app-network

    # 3. Бекенд (Server)
    server:
        build: ./server
        container_name: corpmind-server
        restart: always
        depends_on:
            - db
            - chroma
        environment:
            PORT: 5000
            # Налаштування БД
            DB_USER: ${POSTGRES_USER}
            DB_PASSWORD: ${POSTGRES_PASSWORD}
            DB_HOST: db
            DB_PORT: 5432
            DB_NAME: ${POSTGRES_DB}

            # Налаштування AI
            CHROMA_URL: http://chroma:8000

            # Ключі з .env
            JWT_SECRET: ${JWT_SECRET}
            GEMINI_API_KEY: ${GEMINI_API_KEY}
            EMAIL_USER: ${EMAIL_USER}
            EMAIL_PASS: ${EMAIL_PASS}
            CLIENT_URL: http://localhost:80
        volumes:
            - ./server/uploads:/app/uploads
        networks:
            - app-network

    # 4. Фронтенд (Client)
    client:
        build: ./client
        container_name: corpmind-client
        restart: always
        depends_on:
            - server
        ports:
            - '80:80'
        networks:
            - app-network

volumes:
    postgres_data:
    chroma_data:

networks:
    app-network:
        driver: bridge
